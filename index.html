<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visual Signal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: Courier, monospace; user-select: none; -webkit-user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #status-text {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: #444; font-size: 14px; pointer-events: none; letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* ADMIN PANEL */
        #admin-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 999; flex-direction: column;
        }
        .btn {
            flex: 1; border-bottom: 1px solid #333; color: #fff; font-size: 2rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            background: #000; text-transform: uppercase; cursor: pointer;
        }
        .btn:active { background: #fff; color: #000; }
        .stop-btn { color: #f55; height: 80px; flex: none; }
        
        #connection-status {
            color: #0f0; font-size: 10px; position: absolute; top: 10px; right: 10px; display: none; opacity: 0.5;
        }
    </style>
</head>
<body>

    <label style="opacity: 0; position: absolute; pointer-events: none; top: -100px;">
        <input type="checkbox" id="haptic-switch">
    </label>

    <div id="connection-status">‚óè LINKED</div>
    <canvas id="canvas"></canvas>
    <div id="status-text">SIGNAL NOISE: 100%</div>

    <div id="admin-panel">
        <div style="padding:10px; color:#666; font-size:12px; text-align:center;">CONTROLLER</div>
        <div class="btn" onclick="sendShape('7')">FORCE 7</div>
        <div class="btn" onclick="sendShape('5')">FORCE 5</div>
        <div class="btn" onclick="sendShape('3')">FORCE 3</div>
        <div class="btn stop-btn" onclick="sendShape('stop')">RESET</div>
    </div>

<script>
    // --- HAPTIC ENGINE (IOS + ANDROID) ---
    function triggerHaptic() {
        // 1. Android Buzz
        if(navigator.vibrate) navigator.vibrate(200);
        
        // 2. iOS Click (Switch Hack)
        const switchEl = document.getElementById('haptic-switch');
        if(switchEl) {
            switchEl.checked = !switchEl.checked; // Snap the switch
        }
    }

    // --- MQTT CONNECTION ---
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('mode') === 'admin';
    const uniqueID = window.location.hash.replace('#', '') || 'demo';
    
    const broker = "broker.hivemq.com";
    const port = 8000;
    const topic = "magic/signal/" + uniqueID;
    const clientID = "user-" + Math.random().toString(16).substr(2, 8);
    let client = new Paho.MQTT.Client(broker, port, clientID);

    let currentShape = null;

    function onConnect() {
        if(isAdmin) {
            document.getElementById('admin-panel').style.display = 'flex';
        } else {
            client.subscribe(topic);
            document.getElementById('connection-status').style.display = 'block';
        }
    }

    function onMessageArrived(msg) {
        const payload = msg.payloadString;
        
        if(payload === 'stop') {
            currentShape = null;
            document.getElementById('status-text').innerText = "SIGNAL NOISE: 100%";
            document.getElementById('status-text').style.color = "#444";
        } else {
            currentShape = payload;
            document.getElementById('status-text').innerText = "SIGNAL LOCKED: " + payload;
            document.getElementById('status-text').style.color = "#fff";
            
            // TRIGGER THE HAPTIC
            triggerHaptic();
        }
    }

    client.connect({ onSuccess: onConnect, useSSL: false });

    function sendShape(val) {
        const message = new Paho.MQTT.Message(val);
        message.destinationName = topic;
        client.send(message);
    }

    // --- VISUALS ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        particles = [];
        for(let i=0; i<4000; i++) {
            particles.push({
                x: Math.random() * width, y: Math.random() * height,
                vx: 0, vy: 0
            });
        }
    }
    window.addEventListener('resize', resize);

    function inShape(x, y, shape) {
        let nx = x/width, ny = y/height;
        const r = (x1,x2,y1,y2) => nx>x1 && nx<x2 && ny>y1 && ny<y2;
        
        if(shape === '7') {
            if (r(0.2,0.8,0.2,0.3)) return true;
            let ix = 0.8 - ((ny-0.3)*0.8);
            if (nx>ix-0.08 && nx<ix+0.08 && ny>0.3 && ny<0.8) return true;
        }
        if(shape === '5') {
            if(r(0.3,0.7,0.2,0.28) || r(0.3,0.4,0.2,0.5) || r(0.3,0.7,0.42,0.52) || r(0.6,0.7,0.5,0.75) || r(0.3,0.7,0.72,0.8)) return true;
        }
        if(shape === '3') {
             if(r(0.3,0.7,0.2,0.28) || r(0.3,0.7,0.45,0.55) || r(0.3,0.7,0.72,0.8) || r(0.6,0.7,0.2,0.8)) return true;
        }
        return false;
    }

    function animate() {
        ctx.fillStyle = 'rgba(0,0,0,0.2)'; // Trails
        ctx.fillRect(0, 0, width, height);

        particles.forEach(p => {
            let inside = currentShape ? inShape(p.x, p.y, currentShape) : false;
            
            if (inside) {
                ctx.fillStyle = '#fff';
                // Snap to position logic would go here, simplistic jitter for now
                p.x += (Math.random()-0.5)*2; 
                p.y += (Math.random()-0.5)*2;
            } else {
                ctx.fillStyle = currentShape ? '#222' : '#555';
                p.x += (Math.random()-0.5)*15; // High chaos
                p.y += (Math.random()-0.5)*15;
            }
            // Wrap
            if(p.x>width) p.x=0; if(p.x<0) p.x=width;
            if(p.y>height) p.y=0; if(p.y<0) p.y=height;
            
            ctx.fillRect(p.x, p.y, 2, 2);
        });
        requestAnimationFrame(animate);
    }
    resize(); animate();

</script>
</body>
</html>
